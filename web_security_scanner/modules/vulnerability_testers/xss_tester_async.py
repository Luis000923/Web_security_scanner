from .base_tester_async import VulnerabilityTester
import urllib.parse
from ...utils.i18n import i18n

class XSSTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.xss')

    @property
    def description(self) -> str:
        return "Checks for Reflected Cross-Site Scripting vulnerabilities."

    async def run_test(self, target_url: str, **kwargs):
        payloads = [
            "<script>alert(1)</script>",
            "\"><script>alert(1)</script>",
            "<img src=x onerror=alert(1)>",
            "' onmouseover='alert(1)",
            "javascript:alert(1)"
        ]
        
        parsed = urllib.parse.urlparse(target_url)
        params = urllib.parse.parse_qs(parsed.query)
        
        if not params:
            return

        await self.event_emitter.emit(
            "LOG_MESSAGE", 
            message=f"Starting XSS test on {target_url}"
        )

        for param_name in params:
            for idx, payload in enumerate(payloads, 1):
                # Log payload being tested
                await self.log_payload(payload, idx, len(payloads))
                
                query = parsed.query.replace(f"{param_name}={params[param_name][0]}", f"{param_name}={payload}")
                test_url = urllib.parse.urlunparse(parsed._replace(query=query))
                
                response = await self.scanner.request("GET", test_url)
                
                if payload in response.get("text", ""):
                    await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.xss'),
                        "url": test_url,
                        "parameter": param_name,
                        "payload": payload,
                        "severity": "High",
                        "evidence": i18n.get('vulnerabilities.evidence.xss_reflected')
                    })
                    break
                
                # Delay between payloads
                await self.delay_between_payloads()
