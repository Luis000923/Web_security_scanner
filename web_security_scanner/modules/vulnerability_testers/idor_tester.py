"""
IDOR (Insecure Direct Object Reference) Vulnerability Tester
"""

import re
from typing import List, Dict
from .base_tester import BaseVulnerabilityTester


class IDORTester(BaseVulnerabilityTester):
    """Tests for IDOR vulnerabilities"""
    
    def get_payloads(self) -> List[str]:
        """Get IDOR test payloads (object IDs to test)"""
        return [
            # Numeric IDs
            '1', '2', '3', '100', '999', '1000',
            '0', '-1', '-2',
            
            # Common patterns
            '../1', '../2',
            '../../1',
            
            # UUID patterns (shortened for testing)
            '00000000-0000-0000-0000-000000000001',
            '11111111-1111-1111-1111-111111111111',
            
            # String IDs
            'admin', 'user', 'test',
            'administrator', 'root',
        ]
    
    def test_url_parameters(self, url: str, parameters: List[str], max_payloads: int = None) -> List[Dict]:
        """
        Test URL parameters for IDOR vulnerabilities
        
        Args:
            url: Base URL
            parameters: List of parameter names
            max_payloads: Maximum payloads to test
            
        Returns:
            List of discovered IDOR vulnerabilities
        """
        vulnerabilities = []
        
        # Look for parameters that likely contain object references
        id_patterns = ['id', 'user', 'uid', 'account', 'profile', 'object', 'file', 'doc', 'item']
        
        for param in parameters:
            param_lower = param.lower()
            
            # Check if parameter name suggests it's an object reference
            is_id_param = any(pattern in param_lower for pattern in id_patterns)
            
            if not is_id_param:
                continue
            
            # Get baseline with original value
            baseline_data = {param: '1'}  # Assume ID 1 as baseline
            baseline = self.scanner.make_request(url, 'GET', data=baseline_data)
            
            if not baseline or baseline.status_code >= 400:
                continue
            
            payloads = self.get_payloads()
            if max_payloads:
                payloads = payloads[:max_payloads]
            
            # Test different IDs
            for payload in payloads:
                try:
                    data = {param: payload}
                    response = self.scanner.make_request(url, 'GET', data=data)
                    
                    if response and self.check_vulnerability(response, baseline, payload):
                        vuln_info = self.get_vulnerability_info()
                        vulnerabilities.append({
                            'url': url,
                            'method': 'GET',
                            'payload': payload,
                            'parameters': [param],
                            'type': vuln_info['name'],
                            'severity': vuln_info['severity'],
                            'description': f"{vuln_info['description']} - Parameter '{param}' allows access to different objects without authorization.",
                            'cwe': vuln_info.get('cwe'),
                            'owasp': vuln_info.get('owasp')
                        })
                        
                        self.logger.vulnerability(
                            vuln_info['name'],
                            url,
                            {'parameter': param, 'tested_id': payload}
                        )
                        break  # Found IDOR, move to next parameter
                        
                except Exception as e:
                    self.logger.error(f"Error testing IDOR on parameter {param}: {e}")
        
        return vulnerabilities
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Check if response indicates IDOR vulnerability"""
        if not response or not baseline:
            return False
        
        # IDOR is found when:
        # 1. Response is successful (200)
        # 2. Content differs from baseline
        # 3. No authorization error
        
        if response.status_code != 200:
            return False
        
        # If response is identical to baseline, not an IDOR
        if response.text == baseline.get('text', ''):
            return False
        
        # Check if response indicates success and different data
        if self._response_differs_significantly(response, baseline):
            # Make sure it's not an error response
            response_lower = response.text.lower()
            
            error_indicators = [
                'unauthorized',
                'forbidden',
                'access denied',
                'permission denied',
                'not authorized',
                'insufficient privileges',
                'not found',
                '404',
                '403',
                '401',
                'error',
            ]
            
            # If no error indicators, likely successful IDOR
            has_errors = any(indicator in response_lower for indicator in error_indicators)
            
            if not has_errors:
                # Additional check: look for user/data indicators
                data_indicators = [
                    'email',
                    'username',
                    'profile',
                    'account',
                    'name',
                    'address',
                    'phone',
                    'data',
                ]
                
                has_data = any(indicator in response_lower for indicator in data_indicators)
                
                if has_data:
                    return True
        
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return IDOR vulnerability information"""
        return {
            'name': 'Insecure Direct Object Reference (IDOR)',
            'severity': 'high',
            'description': 'The application is vulnerable to IDOR, allowing unauthorized access to objects by manipulating reference identifiers.',
            'cwe': 'CWE-639',
            'owasp': 'A01:2021 - Broken Access Control',
            'impact': 'Unauthorized data access, information disclosure, and potential data modification.',
            'remediation': 'Implement proper authorization checks, use indirect references, validate user permissions for each object access.'
        }
