"""
CSRF (Cross-Site Request Forgery) Vulnerability Tester
"""

from typing import List, Dict
from bs4 import BeautifulSoup
from .base_tester import BaseVulnerabilityTester


class CSRFTester(BaseVulnerabilityTester):
    """Tests for CSRF vulnerabilities"""
    
    def get_payloads(self) -> List[str]:
        """CSRF doesn't use payloads, returns empty list"""
        return []
    
    def test_form(self, form: Dict, max_payloads: int = None) -> List[Dict]:
        """
        Test form for CSRF vulnerability
        
        Args:
            form: Form dictionary
            max_payloads: Not used for CSRF
            
        Returns:
            List of CSRF vulnerabilities found
        """
        vulnerabilities = []
        
        try:
            # Get the form page
            response = self.scanner.make_request(form['action'], 'GET')
            
            if not response:
                return vulnerabilities
            
            # Parse the HTML
            soup = BeautifulSoup(response.text, 'html.parser')
            
            # Find the specific form
            forms = soup.find_all('form')
            
            for html_form in forms:
                form_action = html_form.get('action', '')
                form_method = html_form.get('method', 'GET').upper()
                
                # Normalize action
                if form_action and not form_action.startswith('http'):
                    if form_action.startswith('/'):
                        base = '/'.join(form['action'].split('/')[:3])
                        form_action = base + form_action
                    else:
                        form_action = form['action']
                
                # Only check forms that modify data (POST, PUT, DELETE)
                if form_method not in ['POST', 'PUT', 'DELETE', 'PATCH']:
                    continue
                
                # Check for CSRF token
                has_csrf_token = self._check_csrf_token(html_form)
                
                if not has_csrf_token:
                    vuln_info = self.get_vulnerability_info()
                    vulnerabilities.append({
                        'url': form_action or form['action'],
                        'method': form_method,
                        'payload': 'N/A',
                        'parameters': form.get('inputs', []),
                        'type': vuln_info['name'],
                        'severity': vuln_info['severity'],
                        'description': vuln_info['description'] + ' - No CSRF token found in form.',
                        'cwe': vuln_info.get('cwe'),
                        'owasp': vuln_info.get('owasp')
                    })
                    
                    self.logger.vulnerability(
                        vuln_info['name'],
                        form_action or form['action'],
                        {'method': form_method}
                    )
        
        except Exception as e:
            self.logger.error(f"Error testing CSRF: {e}")
        
        return vulnerabilities
    
    def _check_csrf_token(self, form) -> bool:
        """Check if form contains CSRF token"""
        # Common CSRF token field names
        csrf_names = [
            'csrf',
            'csrf_token',
            'csrftoken',
            'csrf-token',
            '_csrf',
            '_csrf_token',
            'authenticity_token',
            'token',
            'xsrf',
            'xsrf_token',
            '__requestverificationtoken',
            'anti-csrf-token',
        ]
        
        # Check input fields
        inputs = form.find_all('input')
        for input_field in inputs:
            name = input_field.get('name', '').lower()
            field_id = input_field.get('id', '').lower()
            
            for csrf_name in csrf_names:
                if csrf_name in name or csrf_name in field_id:
                    return True
        
        # Check meta tags (some frameworks use meta tags for CSRF)
        meta_tags = form.find_all('meta')
        for meta in meta_tags:
            name = meta.get('name', '').lower()
            if any(csrf_name in name for csrf_name in csrf_names):
                return True
        
        return False
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Not used for CSRF testing"""
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return CSRF vulnerability information"""
        return {
            'name': 'Cross-Site Request Forgery (CSRF)',
            'severity': 'high',
            'description': 'The application is vulnerable to CSRF attacks, allowing attackers to perform unauthorized actions on behalf of authenticated users.',
            'cwe': 'CWE-352',
            'owasp': 'A01:2021 - Broken Access Control',
            'impact': 'Unauthorized actions, privilege escalation, data modification, and account compromise.',
            'remediation': 'Implement CSRF tokens, use SameSite cookie attribute, verify Origin/Referer headers, require re-authentication for sensitive actions.'
        }
