from .base_tester_async import VulnerabilityTester
import urllib.parse
from ...utils.i18n import i18n

class PathTraversalTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.path_traversal')

    @property
    def description(self) -> str:
        return "Checks for Path Traversal vulnerabilities."

    async def run_test(self, target_url: str, **kwargs):
        payloads = [
            "../../../../etc/passwd",
            "..\\..\\..\\..\\windows\\win.ini",
            "../../../../boot.ini",
            "/etc/passwd"
        ]
        
        parsed = urllib.parse.urlparse(target_url)
        params = urllib.parse.parse_qs(parsed.query)
        
        if not params:
            return

        await self.event_emitter.emit(
            "LOG_MESSAGE", 
            message=f"Starting Path Traversal test on {target_url}"
        )

        for param_name in params:
            for idx, payload in enumerate(payloads, 1):
                # Log payload being tested
                await self.log_payload(payload, idx, len(payloads))
                
                query = parsed.query.replace(f"{param_name}={params[param_name][0]}", f"{param_name}={payload}")
                test_url = urllib.parse.urlunparse(parsed._replace(query=query))
                
                response = await self.scanner.request("GET", test_url)
                text = response.get("text", "")
                
                if "root:x:0:0:" in text or "[extensions]" in text or "[boot loader]" in text:
                    await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.path_traversal'),
                        "url": test_url,
                        "parameter": param_name,
                        "payload": payload,
                        "severity": "High",
                        "evidence": i18n.get('vulnerabilities.evidence.path_traversal')
                    })
                    break
                
                # Delay between payloads
                await self.delay_between_payloads()
