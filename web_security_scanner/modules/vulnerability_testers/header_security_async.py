from .base_tester_async import VulnerabilityTester
from ...events.event_emitter import ScanEventType
from ...utils.i18n import i18n

class HeaderSecurityTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.missing_header')

    @property
    def description(self) -> str:
        return "Checks for missing security headers in HTTP responses."

    async def run_test(self, target_url: str, **kwargs):
        await self.event_emitter.emit(
            ScanEventType.LOG_MESSAGE, 
            message=f"Analyzing HTTP headers for {target_url}..."
        )

        response = await self.scanner.request("GET", target_url)
        headers = response.get("headers", {})
        
        # Check for missing security headers
        security_headers = {
            "X-Frame-Options": "Clickjacking protection",
            "X-Content-Type-Options": "MIME sniffing protection",
            "Content-Security-Policy": "Content Security Policy",
            "Strict-Transport-Security": "HSTS (SSL/TLS security)",
            "X-XSS-Protection": "XSS Protection"
        }

        for header, desc in security_headers.items():
            # Case-insensitive check
            if not any(h.lower() == header.lower() for h in headers.keys()):
                await self.report_vulnerability({
                    "type": i18n.get('vulnerabilities.missing_header'),
                    "url": target_url,
                    "severity": "Low",
                    "payload": header,
                    "evidence": i18n.get('vulnerabilities.evidence.missing_header', header=header)
                })

        # Check for information disclosure headers
        info_headers = ["Server", "X-Powered-By", "X-AspNet-Version"]
        for header in info_headers:
            for h_name, h_val in headers.items():
                if h_name.lower() == header.lower():
                     await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.info_disclosure'),
                        "url": target_url,
                        "severity": "Info",
                        "payload": h_name,
                        "evidence": i18n.get('vulnerabilities.evidence.info_header', value=h_val)
                    })
