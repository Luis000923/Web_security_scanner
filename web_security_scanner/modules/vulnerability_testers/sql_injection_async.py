from .base_tester_async import VulnerabilityTester
import urllib.parse
from ...utils.i18n import i18n

class SQLInjectionTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.sql_injection')

    @property
    def description(self) -> str:
        return "Checks for common SQL Injection vulnerabilities in URL parameters."

    async def run_test(self, target_url: str, **kwargs):
        payloads = [
            "'", 
            "1' OR '1'='1", 
            "' OR 1=1--", 
            "' UNION SELECT NULL--",
            "admin' --"
        ]
        
        # Parse URL to find parameters
        parsed = urllib.parse.urlparse(target_url)
        params = urllib.parse.parse_qs(parsed.query)
        
        if not params:
            await self.event_emitter.emit(
                "LOG_MESSAGE", 
                message=f"SQLi: No parameters found in URL {target_url}. Skipping parameter injection."
            )
            return

        await self.event_emitter.emit(
            "LOG_MESSAGE", 
            message=f"Starting SQLi test on {target_url} with {len(payloads)} payloads."
        )

        for param_name in params:
            for idx, payload in enumerate(payloads, 1):
                # Log payload being tested
                await self.log_payload(payload, idx, len(payloads))
                
                # Construct URL with payload
                query = parsed.query.replace(f"{param_name}={params[param_name][0]}", f"{param_name}={payload}")
                test_url = urllib.parse.urlunparse(parsed._replace(query=query))
                
                response = await self.scanner.request("GET", test_url)
                
                if self._check_sqli_error(response.get("text", "")):
                    await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.sql_injection'),
                        "url": test_url,
                        "parameter": param_name,
                        "payload": payload,
                        "severity": "High",
                        "evidence": i18n.get('vulnerabilities.evidence.sqli_error')
                    })
                    # Stop testing this parameter if vulnerable
                    break
                
                # Delay between payloads
                await self.delay_between_payloads()

    def _check_sqli_error(self, text: str) -> bool:
        errors = [
            "SQL syntax",
            "mysql_fetch_array",
            "ORA-01756",
            "SQLite3::query",
            "pg_query"
        ]
        return any(error.lower() in text.lower() for error in errors)
