"""
NoSQL Injection Vulnerability Tester
"""

import json
from typing import List, Dict
from pathlib import Path
from .base_tester import BaseVulnerabilityTester


class NoSQLInjectionTester(BaseVulnerabilityTester):
    """Tests for NoSQL injection vulnerabilities"""
    
    def __init__(self, scanner_core, config, logger):
        super().__init__(scanner_core, config, logger)
        self._load_payloads()
    
    def _load_payloads(self):
        """Load NoSQL injection payloads from file"""
        try:
            payload_file = Path(__file__).parent.parent.parent / 'PAYLOAD' / 'payloadsNoSQL.json'
            with open(payload_file, 'r', encoding='utf-8') as f:
                self.payloads_list = json.load(f)
        except Exception as e:
            self.logger.warning(f"Could not load NoSQL payloads: {e}")
            self.payloads_list = self._get_default_payloads()
    
    def get_payloads(self) -> List[str]:
        """Get NoSQL injection payloads"""
        return self.payloads_list
    
    def _get_default_payloads(self) -> List[str]:
        """Default NoSQL injection payloads"""
        return [
            "{'$gt':''}",
            "{'$ne':''}",
            "{'$nin':[]}",
            "{'$exists':true}",
            "{'$regex':'.*'}",
            "' || '1'=='1",
            "' || 1==1//",
            "admin' || '1'=='1",
            "{'$where':'1==1'}",
            "'; return true; var dummy='",
            "'; return 1; var dummy='",
            "$where: '1==1'",
            "'; return this.username == 'admin' && this.password != 'wrong",
            "admin' && this.password != 'wrong",
            "'; sleep(5000); var dummy='",
            "'; while(true){}; var dummy='",
        ]
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Check if response indicates NoSQL injection"""
        if not response or not baseline:
            return False
        
        response_text = response.text.lower()
        
        # NoSQL error messages
        nosql_errors = [
            "mongodb",
            "nosql",
            "typeerror",
            "cannot convert",
            "bson",
            "e11000",
            "referenceerror",
            "uncaught exception",
            "cast to objectid failed",
            "syntaxerror",
            "unexpected token",
            "invalid json",
            "documentnotfounderror",
            "missing value",
            "unterminated string",
            "unexpected end of json input",
            "mongo",
            "couchdb",
            "redis",
            "cassandra",
        ]
        
        for error in nosql_errors:
            if error in response_text:
                return True
        
        # Check for authentication bypass indicators
        auth_bypass_indicators = [
            "welcome",
            "dashboard",
            "logged in",
            "authentication successful",
            "admin panel",
            "profile",
            "logout",
        ]
        
        # If using authentication bypass payloads
        if any(keyword in payload.lower() for keyword in ['||', '&&', '$ne', '$gt', 'admin']):
            for indicator in auth_bypass_indicators:
                if indicator in response_text and indicator not in baseline.get('text', '').lower():
                    return True
        
        # Check for boolean-based NoSQL injection
        if self._response_differs_significantly(response, baseline):
            # Look for NoSQL-specific operators in payload
            if any(op in payload for op in ['$', '{', '}', '||', '&&']):
                return True
        
        # Check for time-based NoSQL injection
        if 'sleep' in payload.lower():
            if hasattr(response, 'elapsed'):
                response_time = response.elapsed.total_seconds()
                if response_time >= 4:
                    return True
        
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return NoSQL injection vulnerability information"""
        return {
            'name': 'NoSQL Injection',
            'severity': 'critical',
            'description': 'The application is vulnerable to NoSQL injection, allowing attackers to manipulate NoSQL database queries.',
            'cwe': 'CWE-943',
            'owasp': 'A03:2021 - Injection',
            'impact': 'Authentication bypass, unauthorized data access, data modification, and potential code execution.',
            'remediation': 'Use parameterized queries, validate and sanitize input, apply least privilege, and use NoSQL-specific security features.'
        }
