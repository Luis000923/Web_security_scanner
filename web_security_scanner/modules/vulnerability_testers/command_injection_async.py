from .base_tester_async import VulnerabilityTester
import urllib.parse
from ...utils.i18n import i18n

class CommandInjectionTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.command_injection')

    @property
    def description(self) -> str:
        return "Checks for Command Injection vulnerabilities."

    async def run_test(self, target_url: str, **kwargs):
        payloads = [
            '; cat /etc/passwd',
            '| cat /etc/passwd',
            '; id',
            '| id',
            '; whoami',
            '| whoami',
            '& type C:\\Windows\\win.ini',
            '| type C:\\Windows\\win.ini',
            '; ver',
            '| ver',
            '& whoami',
            '| whoami'
        ]
        
        parsed = urllib.parse.urlparse(target_url)
        params = urllib.parse.parse_qs(parsed.query)
        
        if not params:
            return

        await self.event_emitter.emit(
            "LOG_MESSAGE", 
            message=f"Starting Command Injection test on {target_url}"
        )

        for param_name in params:
            for idx, payload in enumerate(payloads, 1):
                # Log payload being tested
                await self.log_payload(payload, idx, len(payloads))
                
                query = parsed.query.replace(f"{param_name}={params[param_name][0]}", f"{param_name}={payload}")
                test_url = urllib.parse.urlunparse(parsed._replace(query=query))
                
                response = await self.scanner.request("GET", test_url)
                text = response.get("text", "").lower()
                
                indicators = [
                    "root:x:0:0:",
                    "uid=",
                    "gid=",
                    "groups=",
                    "[extensions]",
                    "[boot loader]",
                    "microsoft windows [version",
                    "nt authority\\system"
                ]

                found = False
                for indicator in indicators:
                    if indicator in text:
                        found = True
                        break
                
                if found:
                    await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.command_injection'),
                        "url": test_url,
                        "parameter": param_name,
                        "payload": payload,
                        "severity": "Critical",
                        "evidence": i18n.get('vulnerabilities.evidence.command_injection')
                    })
                    break
                
                # Delay between payloads
                await self.delay_between_payloads()
