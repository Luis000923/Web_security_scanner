from abc import ABC, abstractmethod
from typing import List, Dict, Any
import logging
import asyncio
from ...core.scanner_core_async import AsyncScannerCore
from ...events.event_emitter import ScanEventEmitter, ScanEventType

class VulnerabilityTester(ABC):
    """
    Abstract base class for all async vulnerability testers.
    """
    def __init__(self, scanner_core: AsyncScannerCore, event_emitter: ScanEventEmitter, config: Dict[str, Any]):
        self.scanner = scanner_core
        self.event_emitter = event_emitter
        self.config = config
        self.logger = logging.getLogger(self.__class__.__name__)
        # Delay entre payloads para evitar alertas (en segundos)
        self.payload_delay = config.get('payload_delay', 0.5)

    @abstractmethod
    async def run_test(self, target_url: str, **kwargs):
        """
        Execute the vulnerability test against the target URL.
        Should emit VULNERABILITY_FOUND events if issues are detected.
        """
        pass

    @property
    @abstractmethod
    def name(self) -> str:
        """Return the name of the tester."""
        pass

    @property
    @abstractmethod
    def description(self) -> str:
        """Return a description of what the tester does."""
        pass

    async def report_vulnerability(self, vulnerability_data: Dict[str, Any]):
        """Helper to emit a vulnerability found event."""
        await self.event_emitter.emit(
            ScanEventType.VULNERABILITY_FOUND,
            vulnerability=vulnerability_data,
            tester=self.name
        )
    
    async def log_payload(self, payload: str, payload_index: int, total_payloads: int):
        """Log current payload being tested."""
        msg = f"[{self.name}] Testing payload {payload_index}/{total_payloads}: {payload[:50]}..."
        self.logger.info(msg)
        await self.event_emitter.emit(ScanEventType.LOG_MESSAGE, message=msg)
    
    async def delay_between_payloads(self):
        """Wait between payloads to avoid detection."""
        if self.payload_delay > 0:
            await asyncio.sleep(self.payload_delay)
