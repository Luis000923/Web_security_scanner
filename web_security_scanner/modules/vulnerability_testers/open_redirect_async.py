from .base_tester_async import VulnerabilityTester
import urllib.parse
from ...utils.i18n import i18n

class OpenRedirectTester(VulnerabilityTester):
    @property
    def name(self) -> str:
        return i18n.get('vulnerabilities.open_redirect')

    @property
    def description(self) -> str:
        return "Checks for Open Redirect vulnerabilities."

    async def run_test(self, target_url: str, **kwargs):
        payloads = [
            'https://example.com',
            '//example.com',
            'https:example.com',
            '/\\example.com',
            '\\/example.com'
        ]
        
        parsed = urllib.parse.urlparse(target_url)
        params = urllib.parse.parse_qs(parsed.query)
        
        if not params:
            return

        await self.event_emitter.emit(
            "LOG_MESSAGE", 
            message=f"Starting Open Redirect test on {target_url}"
        )

        for param_name in params:
            for idx, payload in enumerate(payloads, 1):
                # Log payload being tested
                await self.log_payload(payload, idx, len(payloads))
                
                query = parsed.query.replace(f"{param_name}={params[param_name][0]}", f"{param_name}={payload}")
                test_url = urllib.parse.urlunparse(parsed._replace(query=query))
                
                response = await self.scanner.request("GET", test_url, allow_redirects=False)
                
                status = response.get("status_code", 0)
                headers = response.get("headers", {})
                location = headers.get("Location", "") or headers.get("location", "")
                
                if status in [301, 302, 303, 307, 308] and ("example.com" in location):
                    await self.report_vulnerability({
                        "type": i18n.get('vulnerabilities.open_redirect'),
                        "url": test_url,
                        "parameter": param_name,
                        "payload": payload,
                        "severity": "Medium",
                        "evidence": i18n.get('vulnerabilities.evidence.open_redirect')
                    })
                    break
                
                # Delay between payloads
                await self.delay_between_payloads()
